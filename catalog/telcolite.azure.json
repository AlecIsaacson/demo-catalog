{
    "services": [
        {
            "id": "simulator",
            "source_repository": "https://github.com/newrelic/demo-simulator.git",
            "deploy_script_path": "deploy/linux/roles",
            "port": 5000,
            "destinations": [
                "simuhost"
            ],
            "files": [
                {
                    "destination_filepath": "engine/startScenario.json",
                    "content": [
                        {
                            "id": "scenarioConsumer",
                            "rpm": "30",
                            "steps": [
                                {
                                    "name": "header",
                                    "params": [
                                        "x-demo-compute-pre-fulfillment",
                                        "[40,60]"
                                    ]
                                },
                                {
                                    "name": "header",
                                    "params": [
                                        "x-demo-malloc-pre-login",
                                        "[20,400]"
                                    ]
                                },
                                {
                                    "name": "httpGet",
                                    "params": [
                                        "[service:webportal]/api/inventory"
                                    ]
                                }
                            ]
                        },
                        {
                            "id": "scenarioPortal",
                            "rpm": "3",
                            "steps": [
                                {
                                    "name": "browserStart",
                                    "params": []
                                },
                                {
                                    "name": "browserGoto",
                                    "params": [
                                        "[service:webportal]"
                                    ]
                                },
                                {
                                    "name": "sleepMs",
                                    "params": [
                                        "1000"
                                    ]
                                }
                            ]
                        },
                        {
                            "id": "scenarioReporting",
                            "rpm": "0",
                            "maxCount": 10,
                            "steps": [
                                {
                                    "name": "header",
                                    "params": [
                                        "x-demo-compute-pre-fulfillment",
                                        "[30000,60000]"
                                    ]
                                },
                                {
                                    "name": "httpGet",
                                    "params": [
                                        "[service:warehouse]/api/inventory/9"
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    "destination_filepath": "engine/cronjob.json",
                    "content": [
                        {
                            "frequency": "0-59/5 * * * *",
                            "job": "curl -i \"[service:simulator]/api/scenario/scenarioReporting/start?rpm=120\""
                        },
                        {
                            "frequency": "1-59/5 * * * *",
                            "job": "curl -i \"[service:simulator]/api/scenario/scenarioReporting/stop\""
                        },
                        {
                            "frequency": "0-59/20 * * * *",
                            "job": "/home/vm-user/simulator/createDeploymentMarker.sh >> createDeploymentMarker.log"
                        }
                    ]
                },
                {
                    "destination_filepath": "engine/createDeploymentMarker.sh",
                    "executable": true,
                    "content": "#!/bin/bash\n service_display_name=\"[service:webportal:display_name]\";api_key=\"[credential:newrelic:personal_api_key]\";base_api_url=\"[app_config:newrelic:api_url]\";options_1='{ \"deployment\": { \"revision\": \"';options_2='\", \"description\": \"Added a deployments resource to the v2 API\", \"user\": \"aswanson@newrelic.com\" }}';options_new=\"${options_1}4.0.0${options_2}\";options_old=\"${options_1}3.9.1${options_2}\";service_id=`curl -X GET \"$base_api_url/v2/applications.json\" -H \"Api-Key:$api_key\" -d \"filter[name]=$service_display_name\"|jq -r '.applications[0].id'`;current_version=`curl -X GET \"$base_api_url/v2/applications/$service_id/deployments.json\" -H \"Api-Key:$api_key\"|jq -r '.deployments[0].revision'`;if [[ $current_version == \"3.9.1\" ]];then options=$options_new;else options=$options_old;fi;curl -X POST \"$base_api_url/v2/applications/$service_id/deployments.json\" -H \"Api-Key:$api_key\" -i -H \"Content-Type: application/json\" -d \"$options\""
                }
            ]
        },
        {
            "id": "webportal",
            "display_name": "Telco-Web Portal",
            "source_repository": "https://github.com/newrelic/demo-nodetron.git",
            "deploy_script_path": "deploy/linux/roles",
            "port": 6001,
            "relationships": [
                "promo",
                "login",
                "inventory",
                "plan",
                "fulfillment"
            ],
            "destinations": [
                "uihost"
            ]
        },
        {
            "id": "warehouse",
            "display_name": "Telco-Warehouse Portal",
            "source_repository": "https://github.com/newrelic/demo-nodetron.git",
            "deploy_script_path": "deploy/linux/roles",
            "port": 6002,
            "relationships": [
                "promo",
                "login",
                "inventory",
                "plan",
                "fulfillment"
            ],
            "destinations": [
                "uihost"
            ]
        },
        {
            "id": "login",
            "display_name": "Telco-Login Service",
            "source_repository": "https://github.com/newrelic/demo-javatron.git",
            "deploy_script_path": "deploy/linux/roles",
            "port": 7001,
            "params": {
                "delay_start_ms": 300000
            },
            "destinations": [
                "authhost"
            ]
        },
        {
            "id": "promo",
            "display_name": "Telco-Promo Service",
            "source_repository": "https://github.com/newrelic/demo-pythontron.git",
            "deploy_script_path": "deploy/linux/roles",
            "port": 8001,
            "destinations": [
                "backendhost"
            ]
        },
        {
            "id": "inventory",
            "display_name": "Telco-Inventory Service",
            "source_repository": "https://github.com/newrelic/demo-pythontron.git",
            "deploy_script_path": "deploy/linux/roles",
            "port": 8003,
            "destinations": [
                "backendhost"
            ]
        },
        {
            "id": "plan",
            "display_name": "Telco-Plan Service",
            "source_repository": "https://github.com/newrelic/demo-pythontron.git",
            "deploy_script_path": "deploy/linux/roles",
            "port": 8004,
            "destinations": [
                "backendhost"
            ]
        },
        {
            "id": "fulfillment",
            "display_name": "Telco-Fulfillment Service",
            "source_repository": "https://github.com/newrelic/demo-pythontron.git",
            "deploy_script_path": "deploy/linux/roles",
            "port": 8005,
            "relationships": [
                "billing"
            ],
            "destinations": [
                "backendhost"
            ]
        },
        {
            "id": "billing",
            "display_name": "Telco-Billing Service",
            "source_repository": "https://github.com/newrelic/demo-javatron.git",
            "deploy_script_path": "deploy/linux/roles",
            "port": 9001,
            "destinations": [
                "reportinghost"
            ]
        },
        {
            "id": "fluentd",
            "destinations": [
                "uihost",
                "backendhost",
                "reportinghost",
                "authhost"
            ],
            "source_repository": "https://github.com/newrelic/demo-fluentd.git",
            "deploy_script_path": "deploy/linux/roles",
            "port": 9999
        }
    ],
    "global_tags": {
        "dxOwningTeam": "DemoX",
        "dxEnvironment": "development",
        "dxDepartment": "Area51",
        "dxProduct": "AcmeTelcoLite"
    },
    "resources": [
        {
            "id": "simuhost",
            "provider": "azure",
            "type": "vm",
            "size": "Standard_B1s"
        },
        {
            "id": "uihost",
            "display_name": "Telco-UI-host",
            "provider": "azure",
            "type": "vm",
            "size": "Standard_B1s"
        },
        {
            "id": "authhost",
            "display_name": "Telco-Authentication-host",
            "provider": "azure",
            "type": "vm",
            "size": "Standard_B1s"
        },
        {
            "id": "backendhost",
            "display_name": "Telco-Backend-host",
            "provider": "azure",
            "type": "vm",
            "size": "Standard_B1s"
        },
        {
            "id": "reportinghost",
            "display_name": "Telco-Reporting-host",
            "provider": "azure",
            "type": "vm",
            "size": "Standard_B1s"
        }
    ],
    "instrumentations": {
        "resources": [
            {
                "id": "nr_infra",
                "resource_ids": [
                    "uihost",
                    "authhost",
                    "backendhost",
                    "reportinghost"
                ],
                "provider": "newrelic",
                "source_repository": "https://github.com/newrelic/demo-newrelic-instrumentation.git",
                "deploy_script_path": "deploy/linux/roles",
                "version": "1.12.4"
            }
        ],
        "services": [
            {
                "id": "nr_node_agent",
                "service_ids": [
                    "webportal",
                    "warehouse"
                ],
                "provider": "newrelic",
                "source_repository": "https://github.com/newrelic/demo-newrelic-instrumentation.git",
                "deploy_script_path": "deploy/node/linux/roles",
                "version": "6.13.0"
            },
            {
                "id": "nr_python_agent",
                "service_ids": [
                    "promo",
                    "inventory",
                    "plan",
                    "fulfillment"
                ],
                "provider": "newrelic",
                "source_repository": "https://github.com/newrelic/demo-newrelic-instrumentation.git",
                "deploy_script_path": "deploy/python/linux/roles",
                "version": "5.18.0.148"
            },
            {
                "id": "nr_java_agent",
                "service_ids": [
                    "billing",
                    "login"
                ],
                "provider": "newrelic",
                "source_repository": "https://github.com/newrelic/demo-newrelic-instrumentation.git",
                "deploy_script_path": "deploy/java/linux/tomcat/roles",
                "version": "6.0.0"
            },
            {
                "id": "nr_logging_in_context",
                "service_ids": [
                    "webportal",
                    "promo",
                    "inventory",
                    "plan",
                    "fulfillment",
                    "billing",
                    "login",
                    "warehouse"
                ],
                "provider": "newrelic",
                "source_repository": "https://github.com/newrelic/demo-newrelic-instrumentation.git",
                "deploy_script_path": "deploy/logging_in_context/roles"
            },
            {
                "id": "nr_alert_service",
                "service_ids": [
                    "webportal",
                    "promo",
                    "inventory",
                    "plan",
                    "fulfillment",
                    "warehouse",
                    "billing",
                    "login"
                ],
                "provider": "newrelic",
                "source_repository": "https://github.com/newrelic/demo-newrelic-instrumentation.git",
                "deploy_script_path": "deploy/alerts/restapi/roles",
                "params": {
                    "alert_duration": 5,
                    "alert_response_time_threshold": 5,
                    "alert_throughput_threshold": 5,
                    "alert_error_percentage_threshold": 10,
                    "alert_cpu_threshold": 75
                }
            }
        ],
        "global": [
            {
                "id": "nr_golden_dashboard",
                "provider": "newrelic",
                "source_repository": "https://github.com/newrelic/demo-newrelic-instrumentation.git",
                "deploy_script_path": "deploy/dashboards/golden/restapi/roles"
            },
            {
                "id": "nr_golden_workload",
                "provider": "newrelic",
                "source_repository": "https://github.com/newrelic/demo-newrelic-instrumentation.git",
                "deploy_script_path": "deploy/workloads/golden/restapi/roles"
            },
            {
                "id": "nr_azure_integration",
                "provider": "newrelic",
                "provider_credential": "azure",
                "source_repository": "https://github.com/newrelic/demo-newrelic-instrumentation.git",
                "deploy_script_path": "deploy/cloud_providers/azure/restapi/roles"
            }
        ]
    }
}
